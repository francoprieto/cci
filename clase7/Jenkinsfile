node {
    
    stage('Preparacion') { 
        // Limpiamos nuestro workspace
        deleteDir()
        // Clonamos el proyecto
        sh 'git clone https://github.com/DataDog/vulnerable-java-application.git'

    }
    stage('Compilacion y Construimos') {
        dir('vulnerable-java-application'){
            // Compilamos y contruimos el jar
            sh './gradlew clean build bootJar'
        }
    }
    stage('Despliegue') {
        dir('vulnerable-java-application'){
            sh '''
            echo '
            FROM eclipse-temurin:21-jdk-jammy \n
            WORKDIR /app \n
            COPY build/libs/domain-tester-service-0.0.1-SNAPSHOT.jar app.jar \n
            EXPOSE 8080 \n
            CMD ["java", "-jar", "app.jar"] \n
            ' | docker build -t springboot-runner:latest -f - . && \
            nohup docker run --rm -p 9999:8080 springboot-runner:latest &   
            '''            
        }
    }
}