/*
Integrar SonarQube (docker) en el pipeline creado anteriormente.
Crear un stage propio
Ver si se puede generar un reporte que persista en Jenkins.
Ver si se puede o no bloquear el pipeline según nivel de vulnerabilidades encontradas (documentación herramienta).
Gestionar un falso positivo.
Opcional: remediar vulnerabilidades encontradas.
Para este ejercicio hay que tener tanto Jenkins como Sonarqube desplegados en docker y en la misma red. 

Para realizar el ejercicio hay que instalar el plugin "SonarQube Scanner for Jenkins" para poder realizar la conexión entre Jenkins y Sonarqube.
Una vez instalado y configurado (tanto en la sección "System" como en "Tools" con la configuración adecuada que aparece en la documentación), 
creamos el "Credentials" necesario para autenticarnos (será un api token de Sonarqube, descrito también en la documentación) 
y finalmente creamos un pipeline con el siguiente código.
*/
pipeline {
    agent any
    stages {
        stage('Preparacion'){
            steps {
                sh 'rm -rf vulnerable-java-application && git clone https://github.com/DataDog/vulnerable-java-application.git'
            }
        }

        stage('SonarQube analysis') {
            steps {
                script {
                    scannerHome = tool 'sonar-scanner'// debe coincidir con el nombre de definido en Jenkins -> Manage Jenkins -> Tool Configuration
                }
                withSonarQubeEnv('sonar-server') {// Si ha configurado más de una conexión de servidor global, puede especificar su nombre según lo configurado en Jenkins
                    dir('vulnerable-java-application'){
                        sh 'cp ../clase8/build.gradle .'
                        sh './gradlew build sonar -Dsonar.projectKey=vulnerable-java-application'
                    }
                }
            }
        }
        stage('Deploy') {
            steps {
                dir('vulnerable-java-application'){
                    sh '''
                    echo '
                    FROM eclipse-temurin:21-jdk-jammy \n
                    WORKDIR /app \n
                    COPY build/libs/domain-tester-service-0.0.1-SNAPSHOT.jar app.jar \n
                    EXPOSE 8080 \n
                    CMD ["java", "-jar", "app.jar"] \n
                    ' | docker build -t springboot-runner:latest -f - . && \
                    nohup docker run --rm -p 9999:8080 springboot-runner:latest &   
                    '''            
                }
            }
        }
    }
}
